{
  "__inputs": [],
  "__requires": [],
  "uid": "etl-k8s",
  "title": "ETL Demo - Kubernetes",
  "tags": ["kubernetes", "etl-demo"],
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 1,
  "refresh": "30s",
  "templating": {
    "list": [
      {
        "name": "namespace",
        "type": "query",
        "datasource": "Prometheus",
        "refresh": 1,
        "query": "label_values(kube_pod_info, namespace)",
        "current": {"text": "etl-demo", "value": "etl-demo"}
      },
      {
        "name": "role",
        "type": "query",
        "datasource": "Prometheus",
        "refresh": 1,
        "query": "label_values(kube_pod_labels{namespace='$namespace'}, label_role)",
        "includeAll": true,
        "multi": true,
        "current": {"text": "All", "value": ["$__all"]}
      },
      {
        "name": "pod",
        "type": "query",
        "datasource": "Prometheus",
        "refresh": 1,
        "query": "label_values(kube_pod_info{namespace='$namespace', label_role=~'$role'}, pod)",
        "includeAll": true,
        "multi": true,
        "current": {"text": "All", "value": ["$__all"]}
      }
    ]
  },
  "panels": [
    {
      "type": "row",
      "title": "Per-pod CPU / Memory",
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0}
    },
    {
      "type": "timeseries",
      "title": "Pod CPU (mCores)",
      "datasource": "Prometheus",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 1},
      "targets": [
        {
          "expr": "sum by(pod) (rate(container_cpu_usage_seconds_total{namespace='$namespace', pod=~'$pod', container!='POD', image!=''}[5m])) * 1000",
          "legendFormat": "{{pod}}"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "mc"}, "overrides": []}
    },
    {
      "type": "timeseries",
      "title": "Pod Memory (MiB)",
      "datasource": "Prometheus",
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 1},
      "targets": [
        {
          "expr": "sum by(pod) (container_memory_working_set_bytes{namespace='$namespace', pod=~'$pod', container!='POD', image!=''}) / 1024 / 1024",
          "legendFormat": "{{pod}}"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "MiB"}, "overrides": []}
    },
    {
      "type": "row",
      "title": "Aggregated view",
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 9}
    },
    {
      "type": "timeseries",
      "title": "Workers CPU (namespace) mCores",
      "datasource": "Prometheus",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 10},
      "targets": [
        {
          "expr": "sum by(namespace) (rate(container_cpu_usage_seconds_total{namespace='$namespace', pod=~'etl-worker.*', container!='POD', image!=''}[5m])) * 1000",
          "legendFormat": "{{namespace}}"
        },
        {
          "expr": "sum by(role) (rate(container_cpu_usage_seconds_total{namespace='$namespace', pod=~'$pod', label_role=~'$role', container!='POD', image!=''}[5m])) * 1000",
          "legendFormat": "role={{role}}"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "mc"}, "overrides": []}
    },
    {
      "type": "timeseries",
      "title": "Workers Memory (namespace) MiB",
      "datasource": "Prometheus",
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 10},
      "targets": [
        {
          "expr": "sum by(namespace) (container_memory_working_set_bytes{namespace='$namespace', pod=~'etl-worker.*', container!='POD', image!=''}) / 1024 / 1024",
          "legendFormat": "{{namespace}}"
        },
        {
          "expr": "sum by(role) (container_memory_working_set_bytes{namespace='$namespace', pod=~'$pod', label_role=~'$role', container!='POD', image!=''}) / 1024 / 1024",
          "legendFormat": "role={{role}}"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "MiB"}, "overrides": []}
    }
  ]
}
